# Custom ModSecurity Rules for ft_transcendence
# This file contains application-specific WAF rules

# ============================================================================
# CUSTOM RULES FOR YOUR APPLICATION
# ============================================================================

# Rule 9001: Block common XSS patterns
SecRule ARGS "@rx (?i)(<script|javascript:|onerror=|onload=)" \
    "id:9001,\
    phase:2,\
    block,\
    log,\
    msg:'XSS Attack Detected',\
    severity:CRITICAL,\
    tag:'application-security',\
    tag:'xss'"

# Rule 9002: Block SQL injection attempts
SecRule ARGS "@rx (?i)(union.*select|select.*from|insert.*into|delete.*from|drop.*table)" \
    "id:9002,\
    phase:2,\
    block,\
    log,\
    msg:'SQL Injection Attempt Detected',\
    severity:CRITICAL,\
    tag:'application-security',\
    tag:'sqli'"

# Rule 9003: Block path traversal attempts
SecRule ARGS "@rx (?i)(\.\.\/|\.\.\\\\)" \
    "id:9003,\
    phase:2,\
    block,\
    log,\
    msg:'Path Traversal Attempt Detected',\
    severity:WARNING,\
    tag:'application-security',\
    tag:'path-traversal'"

# Rule 9004: Block suspicious user agents
SecRule REQUEST_HEADERS:User-Agent "@rx (?i)(sqlmap|nikto|nmap|masscan|acunetix|netsparker|havij)" \
    "id:9004,\
    phase:1,\
    block,\
    log,\
    msg:'Malicious Scanner Detected',\
    severity:CRITICAL,\
    tag:'application-security',\
    tag:'scanner-detection'"

# Rule 9005: Enforce Content-Type for POST/PUT requests
SecRule REQUEST_METHOD "@rx ^(POST|PUT|PATCH)$" \
    "id:9005,\
    phase:1,\
    t:none,\
    chain"
    SecRule &REQUEST_HEADERS:Content-Type "@eq 0" \
        "block,\
        log,\
        msg:'Missing Content-Type header for POST/PUT/PATCH request',\
        severity:WARNING,\
        tag:'application-security',\
        tag:'protocol-enforcement'"

# Rule 9006: Block dangerous file uploads
SecRule FILES_NAMES "@rx \.(?i:php|phtml|php3|php4|php5|exe|dll|sh|bat|cmd)$" \
    "id:9006,\
    phase:2,\
    block,\
    log,\
    msg:'Dangerous File Upload Attempt',\
    severity:CRITICAL,\
    tag:'application-security',\
    tag:'file-upload'"

# ============================================================================
# ALLOWLIST RULES (Reduce False Positives)
# ============================================================================

# Rule 9100: Bypass ModSecurity for health check endpoint
SecRule REQUEST_URI "@streq /health" \
    "id:9100,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

# Rule 9101: Bypass ModSecurity for metrics endpoint
SecRule REQUEST_URI "@streq /metrics" \
    "id:9101,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

# Rule 9102: Disable ModSecurity for static assets
SecRule REQUEST_URI "@rx \.(jpg|jpeg|png|gif|css|js|ico|svg|woff|woff2|ttf|eot)$" \
    "id:9102,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

# ============================================================================
# MONITORING
# ============================================================================

# Rule 9200: Log high anomaly scores
SecRule TX:ANOMALY_SCORE "@ge 5" \
    "id:9200,\
    phase:5,\
    pass,\
    log,\
    msg:'High Anomaly Score Detected: %{TX.ANOMALY_SCORE}',\
    severity:WARNING,\
    tag:'monitoring'"