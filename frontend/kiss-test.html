<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KISS Game Invites Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4">🎯 KISS Game Invites Test</h1>
            <p class="text-xl text-gray-300">Simple, automatic game invitation system</p>
        </div>

        <!-- Connection Status -->
        <div class="bg-gray-800 p-4 rounded mb-6">
            <h2 class="text-xl mb-2">📡 Connection Status</h2>
            <div id="connection-status" class="text-gray-400">Initializing...</div>
        </div>

        <!-- Test Users -->
        <div class="bg-gray-800 p-4 rounded mb-6">
            <h2 class="text-xl mb-4">👥 Test Users (Click to Invite)</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <!-- Ces boutons seront automatiquement configurés par le système KISS -->
                <button 
                    data-invite-user="1"
                    data-invite-username="alice"
                    class="bg-blue-600 hover:bg-blue-500 p-4 rounded transition duration-200">
                    👤 Alice (ID: 1)
                </button>
                
                <button 
                    data-invite-user="2"
                    data-invite-username="bob"
                    class="bg-green-600 hover:bg-green-500 p-4 rounded transition duration-200">
                    👤 Bob (ID: 2)
                </button>
                
                <button 
                    data-invite-user="3"
                    data-invite-username="charlie"
                    class="bg-purple-600 hover:bg-purple-500 p-4 rounded transition duration-200">
                    👤 Charlie (ID: 3)
                </button>
                
                <button 
                    data-invite-user="4"
                    data-invite-username="diana"
                    class="bg-pink-600 hover:bg-pink-500 p-4 rounded transition duration-200">
                    👤 Diana (ID: 4)
                </button>
                
                <button 
                    data-invite-user="5"
                    data-invite-username="eve"
                    class="bg-red-600 hover:bg-red-500 p-4 rounded transition duration-200">
                    👤 Eve (ID: 5)
                </button>

                <!-- Bouton créé dynamiquement -->
                <div id="dynamic-button-container">
                    <!-- Un bouton sera ajouté ici par JavaScript pour tester la détection dynamique -->
                </div>
            </div>
        </div>

        <!-- Manual Invite -->
        <div class="bg-gray-800 p-4 rounded mb-6">
            <h2 class="text-xl mb-4">📤 Manual Invite</h2>
            <div class="flex gap-4">
                <input 
                    type="number" 
                    id="manual-user-id" 
                    placeholder="User ID" 
                    class="bg-gray-700 text-white p-2 rounded">
                <button 
                    id="manual-invite-btn"
                    class="bg-yellow-600 hover:bg-yellow-500 px-4 py-2 rounded transition">
                    Send Manual Invite
                </button>
            </div>
        </div>

        <!-- Stats -->
        <div class="bg-gray-800 p-4 rounded mb-6">
            <h2 class="text-xl mb-4">📊 System Stats</h2>
            <div id="stats" class="text-gray-400">Loading...</div>
        </div>

        <!-- Logs -->
        <div class="bg-gray-800 p-4 rounded">
            <h2 class="text-xl mb-4">📝 Event Log</h2>
            <div id="event-log" class="bg-gray-900 p-2 rounded h-40 overflow-y-auto text-sm font-mono">
                <div class="text-gray-500">Initializing KISS system...</div>
            </div>
        </div>
    </div>

    <!-- Include KISS System (simulated for test) -->
    <script type="module">
        // Simuler le système KISS pour cette page de test
        
        let connectionStatus = 'disconnected';
        let eventLog = [];
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            eventLog.push(`[${timestamp}] ${message}`);
            
            const logContainer = document.getElementById('event-log');
            const logEntry = document.createElement('div');
            logEntry.className = 'text-green-400 mb-1';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function updateConnectionStatus(status) {
            connectionStatus = status;
            const statusEl = document.getElementById('connection-status');
            
            switch(status) {
                case 'connected':
                    statusEl.innerHTML = '🟢 <strong>Connected</strong> - Ready to send/receive invites';
                    statusEl.className = 'text-green-400';
                    break;
                case 'connecting':
                    statusEl.innerHTML = '🟡 <strong>Connecting...</strong> - Establishing WebSocket connection';
                    statusEl.className = 'text-yellow-400';
                    break;
                case 'disconnected':
                    statusEl.innerHTML = '🔴 <strong>Disconnected</strong> - Unable to send invites';
                    statusEl.className = 'text-red-400';
                    break;
            }
        }
        
        function updateStats() {
            const setupButtons = document.querySelectorAll('[data-kiss-setup="true"]').length;
            const totalButtons = document.querySelectorAll('[data-invite-user]').length;
            
            document.getElementById('stats').innerHTML = `
                <div>Setup Buttons: <strong>${setupButtons}/${totalButtons}</strong></div>
                <div>Connection: <strong>${connectionStatus}</strong></div>
                <div>Event Log Entries: <strong>${eventLog.length}</strong></div>
            `;
        }
        
        // Simuler la configuration des boutons KISS
        function setupKissButtons() {
            const buttons = document.querySelectorAll('[data-invite-user]:not([data-kiss-setup])');
            
            buttons.forEach(button => {
                const userId = button.getAttribute('data-invite-user');
                const username = button.getAttribute('data-invite-username');
                
                // Marquer comme configuré
                button.setAttribute('data-kiss-setup', 'true');
                
                // Ajouter l'icône
                if (!button.innerHTML.includes('🎮')) {
                    button.innerHTML = `🎮 ${button.innerHTML}`;
                }
                
                // Event listener
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    addLog(`🎮 KISS: Sending invite to ${username} (ID: ${userId})`);
                    
                    // Simuler le feedback visuel
                    button.style.opacity = '0.7';
                    button.innerHTML = button.innerHTML.replace('🎮', '⏳');
                    
                    setTimeout(() => {
                        button.innerHTML = button.innerHTML.replace('⏳', '✅');
                        addLog(`✅ Invite sent to ${username}`);
                    }, 500);
                    
                    setTimeout(() => {
                        button.style.opacity = '1';
                        button.innerHTML = button.innerHTML.replace('✅', '🎮');
                    }, 2000);
                });
                
                // Tooltip
                button.title = `Challenge ${username} to a Pong match!`;
            });
            
            if (buttons.length > 0) {
                addLog(`🔧 Setup ${buttons.length} invite buttons`);
            }
        }
        
        // Simuler une invitation reçue
        function simulateIncomingInvite() {
            const senderNames = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eve'];
            const randomSender = senderNames[Math.floor(Math.random() * senderNames.length)];
            
            addLog(`📨 Received invite from ${randomSender}`);
            
            // Créer un popup simulé
            const popup = document.createElement('div');
            popup.className = `
                fixed top-4 right-4 z-50 
                bg-green-800 border-2 border-white text-white 
                p-4 rounded-lg shadow-lg 
                w-[350px] max-w-[90vw]
                animate-fade-in
            `;
            
            popup.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-xl font-bold">🎮 Game Invite!</h3>
                    <button class="text-lg hover:scale-110 transition cursor-pointer" onclick="this.parentElement.parentElement.remove()">✕</button>
                </div>
                <div class="mb-4">
                    <p class="text-lg mb-2"><strong>${randomSender}</strong> wants to play!</p>
                    <p class="text-sm opacity-80">⏰ Expires in 60 seconds</p>
                </div>
                <div class="flex gap-3">
                    <button class="flex-1 bg-green-600 hover:bg-green-500 px-4 py-2 rounded font-bold transition duration-200" 
                            onclick="acceptInvite('${randomSender}', this.parentElement.parentElement)">
                        ✅ Accept
                    </button>
                    <button class="flex-1 bg-red-600 hover:bg-red-500 px-4 py-2 rounded font-bold transition duration-200"
                            onclick="declineInvite('${randomSender}', this.parentElement.parentElement)">
                        ❌ Decline
                    </button>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Auto-expire après 60 secondes
            setTimeout(() => {
                if (document.body.contains(popup)) {
                    addLog(`⏰ Invite from ${randomSender} expired`);
                    popup.remove();
                }
            }, 60000);
        }
        
        // Fonctions globales pour les boutons de popup
        window.acceptInvite = function(sender, popup) {
            addLog(`✅ Accepted invite from ${sender} - Starting game...`);
            popup.remove();
        };
        
        window.declineInvite = function(sender, popup) {
            addLog(`❌ Declined invite from ${sender}`);
            popup.remove();
        };
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            addLog('🎯 KISS System initializing...');
            
            // Simuler la connexion
            updateConnectionStatus('connecting');
            
            setTimeout(() => {
                updateConnectionStatus('connected');
                addLog('🔌 WebSocket connected');
                addLog('🔐 Authentication successful');
                
                // Setup des boutons
                setupKissButtons();
                
                // Observer pour les nouveaux boutons
                const observer = new MutationObserver(() => {
                    setupKissButtons();
                    updateStats();
                });
                
                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
                
                updateStats();
                
                // Ajouter un bouton dynamiquement pour tester
                setTimeout(() => {
                    const container = document.getElementById('dynamic-button-container');
                    const dynamicButton = document.createElement('button');
                    dynamicButton.setAttribute('data-invite-user', '99');
                    dynamicButton.setAttribute('data-invite-username', 'dynamic-user');
                    dynamicButton.className = 'bg-cyan-600 hover:bg-cyan-500 p-4 rounded transition duration-200';
                    dynamicButton.innerHTML = '👤 Dynamic User (ID: 99)';
                    container.appendChild(dynamicButton);
                    
                    addLog('🆕 Dynamic button added - should be auto-configured');
                }, 2000);
                
                // Simuler une invitation reçue toutes les 30 secondes
                setInterval(simulateIncomingInvite, 30000);
                
                // Première invitation après 10 secondes
                setTimeout(simulateIncomingInvite, 10000);
                
            }, 1000);
        });
        
        // Configuration du bouton manuel
        document.addEventListener('DOMContentLoaded', () => {
            const manualBtn = document.getElementById('manual-invite-btn');
            const manualInput = document.getElementById('manual-user-id');
            
            manualBtn.addEventListener('click', () => {
                const userId = manualInput.value;
                if (userId && !isNaN(userId)) {
                    addLog(`📤 Manual invite sent to user ID: ${userId}`);
                    manualInput.value = '';
                } else {
                    addLog('❌ Invalid user ID for manual invite');
                }
            });
            
            // Stats update interval
            setInterval(updateStats, 2000);
        });
        
    </script>
</body>
</html>