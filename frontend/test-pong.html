<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Pong - 2 Joueurs</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #222;
      color: white;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .players {
      display: flex;
      gap: 20px;
      justify-content: space-between;
    }
    .player {
      flex: 1;
      border: 2px solid white;
      padding: 20px;
      border-radius: 10px;
      background: #333;
    }
    .player h2 {
      text-align: center;
      color: #4CAF50;
      margin-top: 0;
    }
    .auth-section {
      margin-bottom: 20px;
    }
    .auth-section input {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #555;
      background: #444;
      color: white;
      border-radius: 5px;
    }
    .auth-section button {
      width: 100%;
      padding: 10px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px 0;
    }
    .auth-section button:hover {
      background: #0056b3;
    }
    .auth-section button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    .game-controls {
      margin: 20px 0;
    }
    .game-controls button {
      width: 100%;
      padding: 15px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    .game-controls button:hover {
      background: #1e7e34;
    }
    .game-controls button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    .status {
      padding: 10px;
      background: #444;
      border-radius: 5px;
      min-height: 100px;
      font-family: monospace;
      font-size: 12px;
      line-height: 1.4;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .instructions {
      background: #1a1a1a;
      padding: 20px;
      margin: 20px 0;
      border-radius: 10px;
      border-left: 4px solid #4CAF50;
    }
    .instructions h3 {
      margin-top: 0;
      color: #4CAF50;
    }
    .canvas-container {
      display: flex;
      justify-content: center;
      margin: 30px 0;
      padding: 20px;
      background: #1a1a1a;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üèì Test Pong - 2 Joueurs</h1>
      <p>Interface de test pour v√©rifier le fonctionnement du pong server-sided</p>
    </div>

    <div class="instructions">
      <h3>üìù Instructions de test</h3>
      <p><strong>1.</strong> Authentifiez les deux joueurs avec leurs tokens JWT</p>
      <p><strong>2.</strong> Le Joueur 1 clique sur "D√©marrer une partie"</p>
      <p><strong>3.</strong> Utilisez les contr√¥les clavier :</p>
      <ul>
        <li><strong>Joueur 1 :</strong> W/S ou ‚Üë/‚Üì pour bouger la raquette</li>
        <li><strong>Joueur 2 :</strong> W/S ou ‚Üë/‚Üì pour bouger la raquette</li>
      </ul>
      <p><strong>4.</strong> Observez les logs de statut pour diagnostiquer les probl√®mes</p>
    </div>

    <div class="players">
      <div class="player">
        <h2>üéÆ Joueur 1 (ID: 10)</h2>
        
        <div class="auth-section">
          <input type="text" id="token1" placeholder="JWT Token Joueur 1" />
          <button id="connect1">Se connecter</button>
          <button id="disconnect1" disabled>Se d√©connecter</button>
        </div>
        
        <div class="game-controls">
          <button id="startGame" disabled>D√©marrer une partie</button>
        </div>
        
        <div>
          <h4>üìä Statut de connexion :</h4>
          <div id="status1" class="status">D√©connect√©</div>
        </div>
      </div>

      <div class="player">
        <h2>üéÆ Joueur 2 (ID: 11)</h2>
        
        <div class="auth-section">
          <input type="text" id="token2" placeholder="JWT Token Joueur 2" />
          <button id="connect2">Se connecter</button>
          <button id="disconnect2" disabled>Se d√©connecter</button>
        </div>
        
        <div class="game-controls">
          <button id="spectate" disabled>Mode Spectateur</button>
        </div>
        
        <div>
          <h4>üìä Statut de connexion :</h4>
          <div id="status2" class="status">D√©connect√©</div>
        </div>
      </div>
    </div>

    <div class="canvas-container">
      <canvas id="gameCanvas" width="500" height="200" style="border: 2px solid white; background: #300;"></canvas>
    </div>
  </div>

  <script>
    // Configuration
    const WS_URL = 'ws://localhost:3001/ws';
    const ARENA_WIDTH = 500;
    const ARENA_HEIGHT = 200;
    const PADDLE_WIDTH = 8;
    const PADDLE_HEIGHT = 30;
    const BALL_RADIUS = 5;

    // √âtat global
    let player1 = {
      ws: null,
      connected: false,
      authenticated: false,
      userId: 10, // testplayer1
      input: { up: false, down: false }
    };

    let player2 = {
      ws: null,
      connected: false,
      authenticated: false,
      userId: 11, // testplayer2
      input: { up: false, down: false }
    };

    let gameState = null;
    let currentPlayer = null; // Joueur qui contr√¥le actuellement (pour les inputs clavier)

    // Canvas
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#fff';

    // Fonctions utilitaires
    function log(playerId, message) {
      const statusDiv = document.getElementById(`status${playerId}`);
      const timestamp = new Date().toLocaleTimeString();
      statusDiv.textContent += `[${timestamp}] ${message}\n`;
      statusDiv.scrollTop = statusDiv.scrollHeight;
      console.log(`Player ${playerId}: ${message}`);
    }

    function updateButtons() {
      // Joueur 1
      document.getElementById('connect1').disabled = player1.connected;
      document.getElementById('disconnect1').disabled = !player1.connected;
      document.getElementById('startGame').disabled = !player1.authenticated || !player2.authenticated;

      // Joueur 2
      document.getElementById('connect2').disabled = player2.connected;
      document.getElementById('disconnect2').disabled = !player2.connected;
      document.getElementById('spectate').disabled = !player2.authenticated;
    }

    // Connexion WebSocket
    function connectPlayer(playerId) {
      const player = playerId === 1 ? player1 : player2;
      const token = document.getElementById(`token${playerId}`).value.trim();
      
      if (!token) {
        log(playerId, 'Erreur: Token JWT requis');
        return;
      }

      log(playerId, 'Connexion en cours...');
      
      try {
        player.ws = new WebSocket(WS_URL);
        
        player.ws.onopen = () => {
          log(playerId, 'WebSocket connect√©');
          player.connected = true;
          updateButtons();
          
          // Envoyer l'authentification
          player.ws.send(JSON.stringify({
            type: 'auth',
            token: token
          }));
        };

        player.ws.onmessage = (event) => {
          const message = JSON.parse(event.data);
          handleMessage(playerId, message);
        };

        player.ws.onclose = () => {
          log(playerId, 'WebSocket d√©connect√©');
          player.connected = false;
          player.authenticated = false;
          updateButtons();
        };

        player.ws.onerror = (error) => {
          log(playerId, `Erreur WebSocket: ${error}`);
        };

      } catch (error) {
        log(playerId, `Erreur de connexion: ${error}`);
      }
    }

    // Gestion des messages WebSocket
    function handleMessage(playerId, message) {
      const player = playerId === 1 ? player1 : player2;
      
      log(playerId, `Re√ßu: ${message.type}`);
      
      switch(message.type) {
        case 'connected':
          log(playerId, message.message);
          break;
          
        case 'auth_success':
          log(playerId, `Authentifi√©: ${message.data.username}`);
          player.authenticated = true;
          player.userId = message.data.userId;
          updateButtons();
          break;
          
        case 'auth_error':
          log(playerId, `√âchec auth: ${message.message}`);
          break;
          
        case 'success':
          log(playerId, `Partie d√©marr√©e: ${JSON.stringify(message.data)}`);
          currentPlayer = playerId; // Le joueur qui a d√©marr√© contr√¥le en premier
          break;
          
        case 'game_state':
          gameState = message.data;
          renderGame();
          break;
          
        case 'game_end':
          log(playerId, `Fin de partie: ${JSON.stringify(message.data)}`);
          gameState = null;
          currentPlayer = null;
          break;
          
        case 'err_self':
        case 'err_game_started':
        case 'err_unknown_id':
        case 'err_user_offline':
        case 'err_not_in_game':
          log(playerId, `Erreur: ${message.message}`);
          break;
          
        case 'error':
          log(playerId, `Erreur serveur: ${message.message}`);
          break;
          
        case 'pong':
          // Heartbeat response
          break;
          
        default:
          log(playerId, `Message inconnu: ${message.type}`);
      }
    }

    // Rendu du jeu
    function renderGame() {
      if (!gameState) return;

      // Nettoyer le canvas
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, ARENA_WIDTH, ARENA_HEIGHT);
      ctx.fillStyle = '#fff';

      // Ligne centrale
      ctx.setLineDash([5, 5]);
      ctx.beginPath();
      ctx.moveTo(ARENA_WIDTH / 2, 0);
      ctx.lineTo(ARENA_WIDTH / 2, ARENA_HEIGHT);
      ctx.strokeStyle = '#fff';
      ctx.stroke();
      ctx.setLineDash([]);

      // Raquette gauche
      ctx.fillRect(
        gameState.leftPaddle.pos.x,
        gameState.leftPaddle.pos.y,
        PADDLE_WIDTH,
        PADDLE_HEIGHT
      );

      // Raquette droite
      ctx.fillRect(
        gameState.rightPaddle.pos.x - PADDLE_WIDTH,
        gameState.rightPaddle.pos.y,
        PADDLE_WIDTH,
        PADDLE_HEIGHT
      );

      // Balle
      ctx.beginPath();
      ctx.arc(
        gameState.ball.pos.x,
        gameState.ball.pos.y,
        BALL_RADIUS,
        0,
        2 * Math.PI
      );
      ctx.fill();

      // Scores
      ctx.font = '24px Arial';
      ctx.fillText(
        gameState.leftPaddle.hitCount.toString(),
        ARENA_WIDTH / 4,
        30
      );
      ctx.fillText(
        gameState.rightPaddle.hitCount.toString(),
        (3 * ARENA_WIDTH) / 4,
        30
      );
    }

    // Envoi des inputs
    function sendInput(playerId, input) {
      const player = playerId === 1 ? player1 : player2;
      if (player.ws && player.authenticated) {
        player.ws.send(JSON.stringify({
          type: 'update_input',
          input: input
        }));
      }
    }

    // Gestion des √©v√©nements
    document.getElementById('connect1').addEventListener('click', () => connectPlayer(1));
    document.getElementById('connect2').addEventListener('click', () => connectPlayer(2));

    document.getElementById('disconnect1').addEventListener('click', () => {
      if (player1.ws) {
        player1.ws.close();
      }
    });

    document.getElementById('disconnect2').addEventListener('click', () => {
      if (player2.ws) {
        player2.ws.close();
      }
    });

    document.getElementById('startGame').addEventListener('click', () => {
      if (player1.ws && player1.authenticated) {
        player1.ws.send(JSON.stringify({
          type: 'start_game',
          opponentId: player2.userId
        }));
        log(1, `D√©marrage partie contre joueur ${player2.userId}`);
      }
    });

    document.getElementById('spectate').addEventListener('click', () => {
      log(2, 'Mode spectateur activ√©');
      currentPlayer = 2; // Permettre au joueur 2 de contr√¥ler aussi
    });

    // Gestion du clavier (alternance entre les joueurs)
    document.addEventListener('keydown', (e) => {
      if (!currentPlayer) return;
      
      const player = currentPlayer === 1 ? player1 : player2;
      let inputChanged = false;
      
      switch(e.key.toLowerCase()) {
        case 'w':
        case 'arrowup':
          if (!player.input.up) {
            player.input.up = true;
            inputChanged = true;
          }
          break;
        case 's':
        case 'arrowdown':
          if (!player.input.down) {
            player.input.down = true;
            inputChanged = true;
          }
          break;
        case '1':
          currentPlayer = 1;
          log(1, 'Contr√¥le Joueur 1 activ√©');
          break;
        case '2':
          currentPlayer = 2;
          log(2, 'Contr√¥le Joueur 2 activ√©');
          break;
      }
      
      if (inputChanged) {
        sendInput(currentPlayer, player.input);
      }
    });

    document.addEventListener('keyup', (e) => {
      if (!currentPlayer) return;
      
      const player = currentPlayer === 1 ? player1 : player2;
      let inputChanged = false;
      
      switch(e.key.toLowerCase()) {
        case 'w':
        case 'arrowup':
          if (player.input.up) {
            player.input.up = false;
            inputChanged = true;
          }
          break;
        case 's':
        case 'arrowdown':
          if (player.input.down) {
            player.input.down = false;
            inputChanged = true;
          }
          break;
      }
      
      if (inputChanged) {
        sendInput(currentPlayer, player.input);
      }
    });

    // Initialisation
    updateButtons();
    
    // Ajout de tokens de test par d√©faut si disponibles
    document.addEventListener('DOMContentLoaded', () => {
      // Tokens JWT valides pour nos utilisateurs de test
      document.getElementById('token1').value = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTAsInVzZXJuYW1lIjoidGVzdHBsYXllcjEiLCJlbWFpbCI6InRlc3RwbGF5ZXIxQHRlc3QuY29tIiwiaWF0IjoxNzUzODM0Njg5LCJleHAiOjE3NTM5MjEwODl9.qz4Ubuvm1n-dJY7x404U8nRqrqyHe7tw_GN76OXYyGY';
      document.getElementById('token2').value = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTEsInVzZXJuYW1lIjoidGVzdHBsYXllcjIiLCJlbWFpbCI6InRlc3RwbGF5ZXIyQHRlc3QuY29tIiwiaWF0IjoxNzUzODM0Njk2LCJleHAiOjE3NTM5MjEwOTZ9.gPPE7OyE4uzVZMJT3m_iv8mJ_EuYAg7nyRAP2G0KcQ4';
    });
  </script>
</body>
</html>