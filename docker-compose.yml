services:

  # ====================================================================
  # 1. VAULT SERVICE (Server Only - Always Running)
  # ====================================================================
  vault:
    container_name: vault
    build:
      context: ./vault
      dockerfile: Dockerfile
    cap_add:
      - IPC_LOCK
    ports:
      - "8200:8200"
    volumes:
      - vault_data:/vault/data
      - vault_logs:/vault/logs
      - ./vault/scripts:/vault/scripts:ro
      # CA partagé
      - vault_credentials:/vault_credentials
    environment:
      VAULT_ADDR: "https://vault:8200"
      VAULT_LOG_LEVEL: "info"
    entrypoint: [ "bash", "/vault/scripts/vault-entrypoint.sh" ]
    networks:
      - ft_transcendence
    restart: unless-stopped
    # Healthcheck corrigé : accepte sealed (503) et unsealed (200) comme "healthy"
    healthcheck:
      test: |
        vault status -tls-skip-verify -address=https://vault:8200 > /dev/null 2>&1 || 
        [ $? -eq 2 ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ====================================================================
  # 2. VAULT INITIALIZATION SERVICE
  # ====================================================================
  vault-init:
    container_name: vault-init
    build:
      context: ./vault
      dockerfile: Dockerfile
    command: [ "/bin/bash", "/vault/scripts/init-config.sh" ]
    volumes:
      - vault_credentials:/vault_credentials
      - ./vault/scripts:/vault/scripts:ro
    environment:
      VAULT_ADDR: "https://vault:8200"
      VAULT_SKIP_VERIFY: "true"
    depends_on:
      vault:
        condition: service_healthy
    networks:
      - ft_transcendence
    restart: "no"

  # ====================================================================
  # 3. VAULT AGENT BACKEND
  # ====================================================================
  vault-agent-backend:
    container_name: vault-agent-backend
    image: hashicorp/vault:latest
    volumes:
      - ./vault/config/agent-backend.hcl:/vault/config/agent-backend.hcl:ro
      - vault_credentials:/secrets:ro
      - backend_certs:/app/ssl
    environment:
      VAULT_ADDR: "https://vault:8200"
      VAULT_SKIP_VERIFY: "true"
    entrypoint: [ "vault", "agent", "-config=/vault/config/agent-backend.hcl" ]
    depends_on:
      vault-init:
        condition: service_completed_successfully
    networks:
      - ft_transcendence
    restart: unless-stopped

  # ====================================================================
  # 4. VAULT AGENT NGINX
  # ====================================================================
  vault-agent-nginx:
    container_name: vault-agent-nginx
    image: hashicorp/vault:latest
    volumes:
      - ./vault/config/agent-nginx.hcl:/vault/config/agent-nginx.hcl:ro
      - vault_credentials:/secrets:ro
      - nginx_certs:/etc/nginx/ssl
    environment:
      VAULT_ADDR: "https://vault:8200"
      VAULT_SKIP_VERIFY: "true"
    entrypoint: [ "vault", "agent", "-config=/vault/config/agent-nginx.hcl" ]
    depends_on:
      vault-init:
        condition: service_completed_successfully
    networks:
      - ft_transcendence
    restart: unless-stopped

  # ====================================================================
  # 4. VAULT AGENT FRONTEND
  # ====================================================================
  vault-agent-frontend:
    container_name: vault-agent-frontend
    image: hashicorp/vault:latest
    volumes:
      - ./vault/config/agent-frontend.hcl:/vault/config/agent-frontend.hcl:ro
      - vault_credentials:/secrets:ro
      - frontend_certs:/app/ssl
    environment:
      VAULT_ADDR: "https://vault:8200"
      VAULT_SKIP_VERIFY: "true"
    entrypoint: [ "vault", "agent", "-config=/vault/config/agent-frontend.hcl" ]
    depends_on:
      vault-init:
        condition: service_completed_successfully
    networks:
      - ft_transcendence
    restart: unless-stopped

  # ====================================================================
  # 5. BACKEND SERVICE
  # ====================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    expose:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - /app/node_modules
      - ./db:/app/db
      - backend_certs:/app/ssl:ro
    environment:
      NODE_ENV: "production"
      ENABLE_HTTPS: "true"
      # JWT Configuration
      JWT_SECRET: "${JWT_SECRET}"
      JWT_EXPIRES_IN: "${JWT_EXPIRES_IN}"
      FRONTEND_URL: https://localhost:3000
    depends_on:
      vault-init:
        condition: service_completed_successfully
    networks:
      - ft_transcendence
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet", "--tries=1", "--spider", "https://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
  # ====================================================================
  # 6. MODSECURITY REVERSE PROXY
  # ====================================================================
  modsecurity:
    image: owasp/modsecurity-crs:nginx-alpine
    ports:
      - "8080:8080"
      - "8443:8443"
    volumes:
      - ./modsecurity/nginx.conf:/etc/nginx/templates/conf.d/default.conf.template:ro
      - ./modsecurity/custom-rules.conf:/etc/modsecurity.d/owasp-crs/rules/RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf:ro
      - nginx_certs:/etc/nginx/ssl:ro
      - ./logs/modsecurity/modsec_audit.log:/var/log/modsec_audit.log
    environment:
      - BACKEND=https://backend:8000
      - PROXY=1
      - MODSEC_RULE_REMOVE=920420
      - BLOCKING_PARANOIA=2
      - DETECTION_PARANOIA=2
      
      # HARDENED: Stricter anomaly scoring (lower = more strict)
      - ANOMALY_INBOUND=7
      - ANOMALY_OUTBOUND=5
      
      # HARDENED: Enable all security features
      - MODSEC_RULE_ENGINE=On
      - MODSEC_REQ_BODY_ACCESS=On
      - MODSEC_RESP_BODY_ACCESS=On
      
      # HARDENED: Comprehensive audit logging
      - MODSEC_AUDIT_ENGINE=RelevantOnly
      - MODSEC_AUDIT_LOG=/var/log/modsec_audit.log
      - MODSEC_AUDIT_LOG_FORMAT=JSON
      - MODSEC_AUDIT_LOG_TYPE=Serial
      - MODSEC_AUDIT_LOG_PARTS=ABCDEFGHIJKZ
      
      # HARDENED: Strict request validation
      - ALLOWED_METHODS=GET HEAD POST PUT DELETE OPTIONS PATCH
      - ALLOWED_REQUEST_CONTENT_TYPE=application/json|application/x-www-form-urlencoded|multipart/form-data|text/plain
      - ALLOWED_HTTP_VERSIONS=HTTP/1.1 HTTP/2 HTTP/2.0
      - VALIDATE_UTF8_ENCODING=1
      
      # HARDENED: Size limits
      - MODSEC_REQ_BODY_LIMIT=1048576
      - MODSEC_REQ_BODY_NOFILES_LIMIT=131072
      - MODSEC_RESP_BODY_LIMIT=524288
      - MAX_FILE_SIZE=1048576
      - COMBINED_FILE_SIZES=10485760
      
      # HARDENED: Rate limiting
      - MAX_NUM_ARGS=255
      - ARG_LENGTH=400
      - ARG_NAME_LENGTH=100
      - TOTAL_ARG_LENGTH=6400
      
      # Server configuration
      - PORT=8080
      - SSL_PORT=8443
      - SERVER_NAME=localhost
      - NGINX_ALWAYS_TLS_REDIRECT=off
      
      # Logging (use stdout/stderr instead of files)
      - ERRORLOG=/dev/stderr
      - LOGLEVEL=warn
      - ACCESSLOG=/dev/stdout
      
      # HARDENED: Disable server tokens
      - SERVER_TOKENS=Off
      - MODSEC_SERVER_SIGNATURE=Secure-Server
    depends_on:
      vault-agent-nginx:
        condition: service_started
      backend:
        condition: service_healthy
    networks:
      - ft_transcendence
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-check-certificate", "--quiet", "--tries=1", "--spider", "https://localhost:8443/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  
  # ====================================================================
  # 7. FRONTEND SERVICE
  # ====================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - frontend_certs:/app/ssl:ro
    environment:
      FRONTEND_PORT: 3000
      ENABLE_HTTPS: "true"
      VITE_API_URL: "https://localhost:8443"
    depends_on:
      vault-agent-frontend:
        condition: service_started
      modsecurity:
        condition: service_healthy
    networks:
      - ft_transcendence
    restart: unless-stopped


volumes:
  db_data:
  vault_data:
  vault_logs:
  vault_credentials:
  nginx_certs:
  backend_certs:
  frontend_certs:

networks:
  ft_transcendence:
    driver: bridge